{% extends "base.html" %} {% block style %}
<link
  rel="stylesheet"
  href="{{ url_for('static', filename='style/home.css') }}"
/>
<link
  rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
/>
{% endblock %} {% block content %}
<section class="hero">
  <div class="hero-content">
    <h1 class="hero-title">Discover Korean Cuisine</h1>
    <p class="hero-subtitle">
      Find your perfect Korean dish with personalized taste recommendations and
      authentic user reviews.
    </p>

    <div class="search-section">
      <div class="search-container">
        <input
          type="text"
          id="search-input"
          placeholder="Search for dishes or ingredients..."
          autocomplete="off"
        />
      </div>
      <div
        id="search-results"
        class="search-results"
        style="display: none"
      ></div>
    </div>

    <div class="stats">
      <div class="stat">
        <span class="stat-number" id="total_users">-</span>
        <span class="stat-label">Users</span>
      </div>
      <div class="stat">
        <span class="stat-number" id="total_reviews">-</span>
        <span class="stat-label">Reviews</span>
      </div>
    </div>
  </div>
</section>

<section class="navigation">
  <div class="nav-grid">
    <form action="/dishes" method="post" class="nav-card">
      <div class="nav-icon">
        <i class="fas fa-utensils"></i>
      </div>
      <h3>Dishes</h3>
      <p>Explore Korean dishes & ingredients</p>
      <button type="submit" class="hidden-button"></button>
    </form>

    <form action="/insight" method="post" class="nav-card">
      <div class="nav-icon">
        <i class="fas fa-chart-line"></i>
      </div>
      <h3>Insights</h3>
      <p>View popular dishes & ingredients</p>
      <button type="submit" class="hidden-button"></button>
    </form>

    <form action="/users/list" method="post" class="nav-card">
      <div class="nav-icon">
        <i class="fa-solid fa-user"></i>
      </div>
      <h3>Users</h3>
      <p>Connect with users on this platform</p>
      <button type="submit" class="hidden-button"></button>
    </form>
  </div>
</section>
<script>
  const searchInput = document.getElementById("search-input");
  const searchResults = document.getElementById("search-results");

  let searchItems = [];

  document.addEventListener("DOMContentLoaded", async () => {
    try {
      const res = await fetch("{{ url_for('home.home_api') }}");
      if (!res.ok) throw new Error("Failed to load home data");

      const data = await res.json();

      document.getElementById("total_users").textContent = data.total_users;
      document.getElementById("total_reviews").textContent =
        data.total_reviews +
        data.dietary_total +
        data.ingredient_total +
        data.nutrients_count +
        data.price_reviews +
        data.nutrients_reviews;

      data.dishes.forEach(dish => {
        searchItems.push({
          name: dish.dish_name,
          koreanName: dish.korean_name,
          type: "dish",
          url: "/dishes/" + dish.dish_name
        });
      });

      data.ingredients.forEach(ingredient => {
        searchItems.push({
          name: ingredient.ingredient,
          koreanName: ingredient.korean_name,
          type: "ingredient",
          url: "/ingredients/" + ingredient.ingredient
        });
      });

    } catch (err) {
      console.error(err);
    }
  });

  searchInput.addEventListener("input", function () {
    const query = this.value.toLowerCase().trim();

    if (!query) {
      searchResults.style.display = "none";
      return;
    }

    const matches = searchItems
      .filter(item =>
        item.name.toLowerCase().includes(query) ||
        item.koreanName.toLowerCase().includes(query)
      );

    if (matches.length === 0) {
      searchResults.style.display = "none";
      return;
    }

    renderResults(matches);
  });

  function renderResults(items) {
    searchResults.innerHTML = "";

    items.forEach(item => {
      const el = document.createElement("div");
      el.className = "search-result-item";
      el.innerHTML = `
        <div class="result-icon">
          <i class="fas fa-${item.type === "dish" ? "utensils" : "carrot"}"></i>
        </div>
        <div class="result-content">
          <div class="result-name">${item.koreanName}</div>
          <div class="result-subtitle">${item.name}</div>
        </div>
      `;

      el.onclick = () => window.location.href = item.url;
      searchResults.appendChild(el);
    });

    searchResults.style.display = "block";
  }

  document.addEventListener("click", e => {
    if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
      searchResults.style.display = "none";
    }
  });

  searchInput.addEventListener("keypress", e => {
    if (e.key === "Enter") {
      const query = searchInput.value.toLowerCase().trim();
      const match = searchItems.find(item =>
        item.name.toLowerCase().includes(query) ||
        item.koreanName.toLowerCase().includes(query)
      );
      if (match) window.location.href = match.url;
    }
  });
</script>
{% endblock %}
